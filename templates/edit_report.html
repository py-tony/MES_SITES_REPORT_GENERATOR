{% extends "base.html" %}
{% block content %}

<h4 class="mb-3">Edit Report</h4>

<form method="POST">
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Site Name *</label>
          <input class="form-control" name="site_name" required value="{{ report.site_name }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Location</label>
          <input class="form-control" name="location" value="{{ report.location }}">
        </div>

        <div class="col-md-4">
          <label class="form-label">Report Type *</label>
          <select class="form-select" name="report_type" required>
            {% for t in ["Weekly","Monthly","Incident","Visit Report"] %}
              <option value="{{ t }}" {{ "selected" if report.report_type==t else "" }}>{{ t }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Period Start</label>
          <input type="date" class="form-control" name="period_start" value="{{ report.period_start }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Period End</label>
          <input type="date" class="form-control" name="period_end" value="{{ report.period_end }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Prepared By</label>
          <input class="form-control" name="prepared_by" value="{{ report.prepared_by }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Reporter's Title</label>
          <input class="form-control" name="prepared_by_title" value="{{ report.prepared_by_title }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Department</label>
          <input class="form-control" name="department" value="{{ report.department }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Office Manager</label>
          <input class="form-control" name="office_manager" value="{{ report.office_manager }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Director of IT Department</label>
          <input class="form-control" name="director_it" value="{{ report.director_it }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Date Submitted</label>
          <input type="date" class="form-control" name="date_submitted" value="{{ report.date_submitted }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Overall Status</label>
          <select class="form-select" name="overall_status">
            {% for s in ["Good","Stable","Needs Attention","Critical"] %}
              <option value="{{ s }}" {{ "selected" if report.overall_status==s else "" }}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-12">
          <label class="form-label">Executive Summary</label>
          <textarea class="form-control" rows="3" name="executive_summary">{{ report.executive_summary }}</textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Overview -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h6 class="mb-3">Site Performance Overview</h6>
      <div class="row g-3">
        {% for field, label in [
          ("network_status","Network/Internet"),
          ("power_status","Power/UPS"),
          ("hardware_status","Hardware"),
          ("software_status","Software/Licensing"),
          ("security_status","Security/Access")
        ] %}
        <div class="col-md-4">
          <label class="form-label">{{ label }}</label>
          <select class="form-select" name="{{ field }}">
            <option value="OK" {{ "selected" if report[field]=="OK" else "" }}>OK</option>
            <option value="Issue" {{ "selected" if report[field]=="Issue" else "" }}>Issue</option>
          </select>
        </div>
        {% endfor %}
      </div>
    </div>

      <!-- Devices -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Devices on Site</h6>
            <button type="button" class="btn btn-sm btn-dark" onclick="addDeviceRow()">+ Add Device</button>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle" id="devicesTable">
              <thead class="table-light">
                <tr>
                  <th>Device Name *</th>
                  <th>Hostname</th>
                  <th>Serial Number</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for d in devices %}
                <tr>
                  <td><input class="form-control form-control-sm" name="device_name[]" value="{{ d.device_name }}" /></td>
                  <td><input class="form-control form-control-sm" name="hostname[]" value="{{ d.hostname }}" /></td>
                  <td><input class="form-control form-control-sm" name="serial_number[]" value="{{ d.serial_number }}" /></td>
                  <td>
                    <select class="form-select form-select-sm" name="device_status[]">
                      {% for st in ["Good","Under repair","Broken"] %}
                        <option value="{{ st }}" {{ "selected" if d.status==st else "" }}>{{ st }}</option>
                      {% endfor %}
                    </select>
                  </td>
                  <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">x</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h6 class="mb-3">Cameras & Biometrics</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Cameras</label>
          <div class="row g-2">
            <div class="col-6">
              <input type="number" min="0" class="form-control" name="cameras_live" placeholder="Live" value="{{ report.cameras_live }}" />
            </div>
            <div class="col-6">
              <input type="number" min="0" class="form-control" name="cameras_down" placeholder="Down" value="{{ report.cameras_down }}" />
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Biometrics Access Devices</label>
          <div class="row g-2">
            <div class="col-6">
              <input type="number" min="0" class="form-control" name="biometrics_live" placeholder="Live" value="{{ report.biometrics_live }}" />
            </div>
            <div class="col-6">
              <input type="number" min="0" class="form-control" name="biometrics_down" placeholder="Down" value="{{ report.biometrics_down }}" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Issues -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Issues Logged</h6>
        <button type="button" class="btn btn-sm btn-dark" onclick="addIssueRow()">+ Add Issue</button>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle" id="issuesTable">
          <thead class="table-light">
            <tr>
              <th>Issue Title *</th>
              <th>Area</th>
              <th>Impact</th>
              <th>Status</th>
              <th>Owner</th>
              <th>Action Taken</th>
              <th>Root Cause</th>
              <th>Priority</th>
              <th>Target Date</th>
              <th>Responsible</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for i in issues %}
            <tr>
              <td><input class="form-control form-control-sm" name="issue_title[]" value="{{ i.issue_title }}" /></td>
              <td><input class="form-control form-control-sm" name="area[]" value="{{ i.area }}" /></td>

              <td>
                <select class="form-select form-select-sm" name="impact[]">
                  {% for imp in ["Low","Medium","High","Critical"] %}
                    <option value="{{ imp }}" {{ "selected" if i.impact==imp else "" }}>{{ imp }}</option>
                  {% endfor %}
                </select>
              </td>

              <td>
                <select class="form-select form-select-sm" name="issue_status[]">
                  {% for st in ["Open","In Progress","Resolved"] %}
                    <option value="{{ st }}" {{ "selected" if i.status==st else "" }}>{{ st }}</option>
                  {% endfor %}
                </select>
              </td>

              <td><input class="form-control form-control-sm" name="owner[]" value="{{ i.owner }}" /></td>
              <td><input class="form-control form-control-sm" name="action_taken[]" value="{{ i.action_taken }}" /></td>
              <td><input class="form-control form-control-sm" name="root_cause[]" value="{{ i.root_cause }}" /></td>

              <td>
                <select class="form-select form-select-sm" name="priority[]">
                  {% for pr in ["Low","Medium","High","Critical"] %}
                    <option value="{{ pr }}" {{ "selected" if i.priority==pr else "" }}>{{ pr }}</option>
                  {% endfor %}
                </select>
              </td>

              <td><input type="date" class="form-control form-control-sm" name="target_date[]" value="{{ i.target_date }}" /></td>
              <td><input class="form-control form-control-sm" name="responsible[]" value="{{ i.responsible }}" /></td>

              <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">x</button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Recommendations & Risks -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Recommendations</label>
          <textarea class="form-control" rows="4" name="recommendations">{{ report.recommendations }}</textarea>
        </div>
        <div class="col-md-6">
          <label class="form-label">Risks & Constraints</label>
          <textarea class="form-control" rows="4" name="risks_constraints">{{ report.risks_constraints }}</textarea>
        </div>
        <div class="col-12">
          <label class="form-label">Conclusion</label>
          <textarea class="form-control" rows="3" name="conclusion">{{ report.conclusion }}</textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex gap-2">
    <button class="btn btn-dark">Update Report</button>
    <a class="btn btn-outline-secondary" href="{{ url_for('report_detail', report_id=report.id) }}">Cancel</a>
  </div>
</form>

<script>
function issueRowHTML() {
  return `
  <tr>
    <td><input class="form-control form-control-sm" name="issue_title[]" placeholder="Issue..." /></td>
    <td><input class="form-control form-control-sm" name="area[]" placeholder="Area..." /></td>

    <td>
      <select class="form-select form-select-sm" name="impact[]">
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
        <option value="Critical">Critical</option>
      </select>
    </td>

    <td>
      <select class="form-select form-select-sm" name="issue_status[]">
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Resolved">Resolved</option>
      </select>
    </td>

    <td><input class="form-control form-control-sm" name="owner[]" placeholder="Tech/Team..." /></td>
    <td><input class="form-control form-control-sm" name="action_taken[]" placeholder="Action..." /></td>
    <td><input class="form-control form-control-sm" name="root_cause[]" placeholder="Root cause..." /></td>

    <td>
      <select class="form-select form-select-sm" name="priority[]">
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
        <option value="Critical">Critical</option>
      </select>
    </td>

    <td><input type="date" class="form-control form-control-sm" name="target_date[]" /></td>
    <td><input class="form-control form-control-sm" name="responsible[]" placeholder="Person..." /></td>

    <td class="text-end">
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">x</button>
    </td>
  </tr>
  `;
}

function addIssueRow() {
  document.querySelector("#issuesTable tbody").insertAdjacentHTML("beforeend", issueRowHTML());
}

function removeRow(btn) {
  btn.closest("tr").remove();
}
</script>
<script>
// Devices row functions
function deviceRowHTML() {
  return `
  <tr>
    <td><input class="form-control form-control-sm" name="device_name[]" placeholder="Device name..." required /></td>
    <td><input class="form-control form-control-sm" name="hostname[]" placeholder="Hostname..." /></td>
    <td><input class="form-control form-control-sm" name="serial_number[]" placeholder="Serial..." /></td>
    <td>
      <select class="form-select form-select-sm" name="device_status[]">
        <option value="Good">Good</option>
        <option value="Under repair">Under repair</option>
        <option value="Broken">Broken</option>
      </select>
    </td>
    <td class="text-end">
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">x</button>
    </td>
  </tr>
  `;
}

function addDeviceRow() {
  document.querySelector("#devicesTable tbody").insertAdjacentHTML("beforeend", deviceRowHTML());
}
</script>

{% endblock %}
